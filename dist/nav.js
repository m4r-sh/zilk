function f({pull:G="pull",pages:Z={},redirects:$={}}={}){let W=[],X={onStart:[],onBefore:[],onReady:[],onAfter:[],onError:[],onCancel:[]},A=null,J=!1,K=!1,Q=JSON.parse(sessionStorage.getItem("routerHistory")||"[]");function O(){sessionStorage.setItem("routerHistory",JSON.stringify(Q))}for(let[j,z]of Object.entries(Z)){let B=RegExp("^"+("/"+j).replace(/\/+(\/|$)/g,"$1").replace(/(\/?\.?):(\w+)\+/g,"($1(?<$2>*))").replace(/(\/?\.?):(\w+)/g,"($1(?<$2>[^$1/]+?))").replace(/\./g,"\\.").replace(/(\/?)\*/g,"($1.*)?")+"/*$");W.push({regex:B,handler:async(E)=>{if(z[G])E.pull=await z[G](E);let[N,M]=await Promise.all([z.meta(E),z.content(E)]);return{meta:N,content:M,req:E}}})}function w(j){let{pathname:z,searchParams:B}=new URL(j,location.origin),E=z.replace(/\/+$/,"")||"/";if($[E])return{redirect:$[E]};let N={};for(let[M,F]of B)N[M]=N[M]?[].concat(N[M],F):F;for(let{regex:M,handler:F}of W){let I=E.match(M);if(I){let x=I.groups||{};return{handler:F,params:x,query:N}}}return null}function L(j,z){if(j==="onBefore")return X[j].every((B)=>B(z)!==!1);return X[j].forEach((B)=>B(z)),!0}async function U(j,z=!1,B=0,E=!0){j=j.replace(/\/+$/,"")||"/";let M=location.pathname.replace(/\/+$/,"")||"/";if(j===M&&!z)return;if(!z)Q.push(j),O();else Q[Q.length-1]=j,O();if(J){console.warn("Route already in progress, ignoring:",j);return}J=!0,K=!0,L("onStart",j);let F=w(location.origin+j);if(!F){L("onError",new Error(`No route found for ${j}`)),J=!1,K=!1;return}if(F.redirect){if(B>=8){L("onError",new Error(`Redirect depth exceeded (8) at ${j}`)),J=!1,K=!1;return}history[z?"replaceState":"pushState"]({},"",F.redirect),J=!1,await U(F.redirect,!0,B+1);return}let{handler:I,params:x,query:H}=F,T={params:x,query:H};if(!L("onBefore",T)){L("onCancel",j),J=!1,K=!1;return}try{let Y=await I(T);if(L("onReady",Y),!K)console.warn("Route canceled too late:",j);else if(A){if(K=!1,E)A({...Y,history:Q});history[z?"replaceState":"pushState"]({},"",j),L("onAfter",Y)}else console.warn("No transition handler set for route:",j)}catch(Y){L("onError",Y)}finally{J=!1,K=!1}}function P(j){let z=j.target.closest("a");if(!z)return;let B=z.getAttribute("href");if(!B||z.target||z.host!==location.host||B[0]==="#"||z.hasAttribute("download"))return;if(B[0]==="/")j.preventDefault(),U(B)}function V(j){return(z)=>{return X[j].push(z),()=>{X[j]=X[j].filter((B)=>B!==z)}}}let D={route:U,onStart:V("onStart"),onBefore:V("onBefore"),onReady:V("onReady"),onAfter:V("onAfter"),onError:V("onError"),onCancel:V("onCancel"),performTransition(j){if(A)throw new Error("performTransition can only be set once");A=j},cancel(){if(!J||!K){console.warn("Cannot cancel: No active route or cancelation period has passed");return}L("onCancel",location.pathname),J=!1,K=!1},history:Q};return _("push"),_("replace"),addEventListener("popstate",()=>U(location.pathname+location.search,!0)),addEventListener("replacestate",()=>U(location.pathname+location.search,!0,0,!1)),addEventListener("pushstate",()=>U(location.pathname+location.search,!0)),addEventListener("click",P),D}function _(G,Z){if(history[G])return;history[G]=G,Z=history[G+="State"],history[G]=function($){var W=new Event(G.toLowerCase());return W.uri=$,Z.apply(this,arguments),dispatchEvent(W)}}export{f as createRouter};
